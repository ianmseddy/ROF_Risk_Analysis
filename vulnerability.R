library(magrittr)
#vulnerability

#watershed headwaters 
#calculate watershed and downstream catchment area 
#this wasnt' used for anything in the end
# DEMs <- list.files("data/", recursive = TRUE, full.names = TRUE, pattern = "mea075.tif") %>%
# lapply(., FUN = terra::rast)
# #for climateNA
# DEM <- do.call(terra::merge, DEMs)
# studyAreaT <- terra::project(studyArea, DEM)
# DEM <- mask(DEM, studyAreaT)
# DEM <- trim(DEM)
# writeRaster(DEM, filename = "outputs/tempDEM.asc")
# rm(studyAreaT)
# 
# #for watershed
# DEM <- do.call(terra::merge, DEMs) %>%
#   project(., RTMrast) %>%
#   mask(., RTMrast)
# writeRaster(DEM, "outputs/DEM_Ontario.tif", overwrite = TRUE, datatype = "INT2S")

#refugia from AdaptWest
# https://adaptwest.databasin.org/pages/climatic-macrorefugia-for-trees-and-songbirds/
#start with 2050s
birdRefugia2050 <- rast("data/NA_Refugia/2050s/RCP85_Songbirds/NA_songbird_2050refugia_combo85.tif")

terra::crs(birdRefugia2050) <- "+proj=laea +lat_0=45 +lon_0=-100 +x_0=0 +y_0=0 +ellps=WGS84 +units=m +no_defs"
birdRefugia2050 <- project(birdRefugia2050, RTMrast)
birdRefugia2050 <- mask(birdRefugia2050, RTMrast)
writeRaster(birdRefugia2050, "outputs/birdRefugia2050_RCP85_Ontario.tif")

#tree refugia
treeRefugia2050 <- rast("data/NA_Refugia/2050s/RCP85_Trees/NA_trees_2050refugia_combo85.tif")
crs(treeRefugia2050) <- "+proj=laea +lat_0=45 +lon_0=-100 +x_0=0 +y_0=0 +ellps=WGS84 +units=m +no_defs"
treeRefugia2050 <- project(treeRefugia2050, birdRefugia2050)
treeRefugia2050 <- mask(treeRefugia2050, RTMrast)
writeRaster(treeRefugia2050, "outputs/treeRefugia2050_RCP85_Ontario.tif")

# annual precipitation - we don't have SMI which is apparently more relevant to the east
#
MAP_1961_1990 <- prepInputs(url = paste0("https://s3-us-west-2.amazonaws.com/www.cacpd.org/",
                                          "CMIP6v73/normals/Normal_1961_1990_bioclim.zip"),
                             rasterToMatch = RTMraster, 
                             targetFile = "Normal_1961_1990_MAP.tif",
                             destinationPath = "data")

MAP_2071_2100_ensemble_ssp370 <- prepInputs(url = paste0("https://s3-us-west-2.amazonaws.com/www.cacpd.org/CMIP6v73/",
                                                         "ensembles/ensemble_8GCMs_ssp370_2071_2100_bioclim.zip"),
                                            rasterToMatch = RTMraster,
                                            targetFile = "ensemble_8GCMs_ssp370_2071_2100_MAP.tif",
                                            destinationPath = "data")
pctChangeMAP <- (MAP_2071_2100_ensemble_ssp370 - MAP_1960_1990)/MAP_1960_1990 * 100
writeRaster(pctChangeMAP, "outputs/PctChangeInMAP_2100_ssp370.tif")
#the whole region is expected to get wetter overall
CMI_1961_1990 <- prepInputs(url = paste0("https://s3-us-west-2.amazonaws.com/www.cacpd.org/",
                                         "CMIP6v73/normals/Normal_1961_1990_bioclim.zip"),
                            rasterToMatch = RTMraster, 
                            targetFile = "Normal_1961_1990_CMI.tif",
                            destinationPath = "data")
writeRaster(CMI_1961_1990, "data/CMI_1961_1990_Ontario.tif")
CMI_2071_2100_ensemble_ssp370 <- prepInputs(url = paste0("https://s3-us-west-2.amazonaws.com/www.cacpd.org/CMIP6v73/",
                                                         "ensembles/ensemble_8GCMs_ssp370_2071_2100_bioclim.zip"),
                                            rasterToMatch = RTMraster,
                                            targetFile = "ensemble_8GCMs_ssp370_2071_2100_CMI.tif",
                                            destinationPath = "data")
writeRaster(CMI_2071_2100_ensemble_ssp370, "data/CMI_2071_2100_Ontario.tif")

CMIchange <- CMI_2071_2100_ensemble_ssp370 - CMI_1961_1990
writeRaster(CMIchange, "outputs/projChangeInCMI_2071_2100.tif", overwrite = TRUE)

####CMI change isn't very interesting. What about MDC increase

#download the SSP 3.7 8 CMIP7 AOGCM 30-year period monthly normal 
#https://s3-us-west-2.amazonaws.com/www.cacpd.org/CMIP6v73/ensembles/ensemble_8GCMs_ssp370_2071_2100_monthly.zip
#as well as SSP 4.5
#https://s3-us-west-2.amazonaws.com/www.cacpd.org/CMIP6v73/ensembles/ensemble_8GCMs_ssp245_2071_2100_monthly.zip
#and the normals 
# https://s3-us-west-2.amazonaws.com/www.cacpd.org/CMIP6v73/normals/Normal_1961_1990_monthly.zip

source("makeMDC_ROF.R")
MDCfuture245 <- makeMDC_ROF(inputPath = "data/ensemble_8GCMs_ssp245_2071_2100_monthly/",
                                     years = 2100)
MDCfuture245 <- postProcess(MDCfuture245[[1]], rasterToMatch = RTMraster, 
                            filename2 = "outputs/futureMDC_ssp245_2100.tif", overwrite = TRUE)

MDCfuture370 <- makeMDC_ROF(inputPath = "data/ensemble_8GCMs_ssp370_2071_2100_monthly/",
                            years = 2100)
MDCfuture370 <- postProcess(MDCfuture370[[1]], rasterToMatch = RTMraster, 
                            filename2 = "outputs/futureMDC_ssp370_2100.tif", 
                            overwrite = TRUE)
MDCnormal <- makeMDC_ROF(inputPath = "data/Normal_1961_1990_monthly", 
                         years = 1990)
MDCnormal <- postProcess(MDCnormal[[1]], rasterToMatch = RTMraster,
                         filename2 = "outputs/normalMDC_1961_1990.tif")
changeInMDC_245 <- (MDCfuture245-MDCnormal)/MDCnormal 
changeInMDC_245 <- changeInMDC_245*100
writeRaster(changeInMDC_245, filename = "outputs/pctChangeInMDC_ssp245_2100.tif")
changeInMDC_370 <- (MDCfuture370-MDCnormal)/MDCnormal 
changeInMDC_370 <- changeInMDC_370*100
writeRaster(changeInMDC_370, filename = "outputs/pctChangeInMDC_ssp370_2100.tif")

#maybe we just take the MDC 370? 

#####distance to water #####
# this was calculated using ArcGIS Euclidean distance, first to Ontario linear waterbodies, then polygonal waterbodies
# and then finally taking the minimum of the two. In hindsight, I should have rasterized the two datasets in R, summed them, 
# and then run Euclidean distance, for something more reproducible. The ArcGIS functionw as vastly faster, hoewever

