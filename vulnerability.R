library(magrittr)
#vulnerability

#####refugia from AdaptWest####
# https://adaptwest.databasin.org/pages/climatic-macrorefugia-for-trees-and-songbirds/
#start with 2050s

if (!file.exists("outputs/treeRefugia2050_RCP85_Ontario.tif")){
  # you may have to unzip this file yourself - utils::unzip is unable
  birdRefugia2050 <- prepInputs(url = "https://s3-us-west-2.amazonaws.com/www.cacpd.org/NA_Refugia/NA_Refugia.zip",
                                destinationPath = "data",
                                maskTo = Ontario, projectTo = RTMrast, cropTo = RTMrast, 
                                targetFile = "NA_songbird_2050refugia_combo85.tif",
                                filenae2 = "outputs/birdRefugia2050_RCP85_Ontario.tif")

  #tree refugia
  treeRefugia2050 <- prepInputs(url = "https://s3-us-west-2.amazonaws.com/www.cacpd.org/NA_Refugia/NA_Refugia.zip",
                                destinationPath = "data",
                                maskTo = Ontario, projectTo = RTMrast, cropTo = RTMrast, 
                                targetFile = "NA_trees_2050refugia_combo85.tif",
                                filename2 = "outputs/treeRefugia2050_RCP85_Ontario.tif")
}

#calculating change in CMI - the climate moisture index
#note we could also obtain this climate variable directly from ClimateNA now
####CMI####
if (!file.exists("outputs/projChangeInCMI_2071_2100.tif")) {
  # annual precipitation - we don't have SMI which is apparently more relevant to the east
  MAP_1961_1990 <- prepInputs(url = paste0("https://s3-us-west-2.amazonaws.com/www.cacpd.org/",
                                           "CMIP6v73/normals/Normal_1961_1990_bioclim.zip"),
                              rasterToMatch = RTMrast, 
                              targetFile = "Normal_1961_1990_MAP.tif",
                              destinationPath = "data")
  
  MAP_2071_2100_ensemble_ssp370 <- prepInputs(url = paste0("https://s3-us-west-2.amazonaws.com/www.cacpd.org/CMIP6v73/",
                                                           "ensembles/ensemble_8GCMs_ssp370_2071_2100_bioclim.zip"),
                                              cropTo = RTMrast, projectTo = RTMrast, maskTo = Ontario,
                                              method = "bilinear",
                                              targetFile = "ensemble_8GCMs_ssp370_2071_2100_MAP.tif",
                                              destinationPath = "data")
  pctChangeMAP <- (MAP_2071_2100_ensemble_ssp370 - MAP_1960_1990)/MAP_1960_1990 * 100
  writeRaster(pctChangeMAP, "outputs/PctChangeInMAP_2100_ssp370.tif", overwrite = TRUE)
  #the whole region is expected to get wetter overall
  CMI_1961_1990 <- prepInputs(url = paste0("https://s3-us-west-2.amazonaws.com/www.cacpd.org/",
                                           "CMIP6v73/normals/Normal_1961_1990_bioclim.zip"),
                              cropTo = RTMrast, projectTo = RTMrast, maskTo = Ontario,
                              targetFile = "Normal_1961_1990_CMI.tif",
                              destinationPath = "data")
  writeRaster(CMI_1961_1990, "data/CMI_1961_1990_Ontario.tif", overwrite = TRUE)
  CMI_2071_2100_ensemble_ssp370 <- prepInputs(url = paste0("https://s3-us-west-2.amazonaws.com/www.cacpd.org/CMIP6v73/",
                                                           "ensembles/ensemble_8GCMs_ssp370_2071_2100_bioclim.zip"),
                                              cropTo = RTMrast, projectTo = RTMrast, maskTo = Ontario,
                                              targetFile = "ensemble_8GCMs_ssp370_2071_2100_CMI.tif",
                                              destinationPath = "data")
  writeRaster(CMI_2071_2100_ensemble_ssp370, "data/CMI_2071_2100_Ontario.tif", overwrite = TRUE)
  CMIchange <- CMI_2071_2100_ensemble_ssp370 - CMI_1961_1990
  writeRaster(CMIchange, "outputs/projChangeInCMI_2071_2100.tif", overwrite = TRUE)
}
# CMI is less suitable for Eastern forests - it is used more widely in the west
# MDC - the maximum monthly drought code, has relevance to fire and timber #

#####MDC####
if (!file.exists("outputs/pctChangeInMDC_ssp370_2100.tif")) {
  # download the SSP 3.7 8 CMIP7 AOGCM 30-year period monthly normal 
  # https://s3-us-west-2.amazonaws.com/www.cacpd.org/CMIP6v73/ensembles/ensemble_8GCMs_ssp370_2071_2100_monthly.zip
  # as well as SSP 4.5
  # https://s3-us-west-2.amazonaws.com/www.cacpd.org/CMIP6v73/ensembles/ensemble_8GCMs_ssp245_2071_2100_monthly.zip
  # and the normals 
  # https://s3-us-west-2.amazonaws.com/www.cacpd.org/CMIP6v73/normals/Normal_1961_1990_monthly.zip
  

  #get SSP 370 monthly data
  fp <- paste0("https://s3-us-west-2.amazonaws.com/www.cacpd.org/",
               "CMIP6v73/ensembles/ensemble_8GCMs_ssp370_2071_2100_monthly.zip")
  download.file(url = fp, destfile = "data/ensemble_8GCMs_ssp370_2071_2100_monthly.zip", method = "wininet")
  utils::unzip(zipfile = "data/ensemble_8GCMs_ssp245_2071_2100_monthly.zip", exdir = "data")
  
  #get SSP 245 monthly data
  fp <- paste0("https://s3-us-west-2.amazonaws.com/www.cacpd.org/",
               "CMIP6v73/ensembles/ensemble_8GCMs_ssp245_2071_2100_monthly.zip")
  download.file(url = fp, destfile = "data/ensemble_8GCMs_ssp245_2071_2100_monthly.zip", method = "wininet")
  #wininet is deprecated but triggers the correct behavior
  utils::unzip(zipfile = "data/ensemble_8GCMs_ssp245_2071_2100_monthly.zip", exdir = "data")
  
  #get climate normals 
  download.file("https://s3-us-west-2.amazonaws.com/www.cacpd.org/CMIP6v73/normals/Normal_1961_1990_monthly.zip", 
                 destfile = "data/Normal_1961_1990_monthly.zip", method = "wininet")
  utils::unzip(zipfile = "data/Normal_1961_1990_monthly.zip", exdir = "data")
  
  source("makeMDC_ROF.R")
  
  MDCfuture245 <- makeMDC_ROF(inputPath = "data/ensemble_8GCMs_ssp245_2071_2100_monthly/",
                              years = 2100)
  MDCfuture245 <- postProcess(MDCfuture245[[1]], rasterToMatch = RTMraster, 
                              filename2 = "outputs/futureMDC_ssp245_2100.tif", overwrite = TRUE)
  
  #for some reason 'monthly'  is not part of this directory name?
  MDCfuture370 <- makeMDC_ROF(inputPath = "data/ensemble_8GCMs_ssp370_2071_2100/",
                              years = 2100)
  
  MDCfuture370 <- postProcess(MDCfuture370[[1]], rasterToMatch = RTMraster, 
                              filename2 = "outputs/futureMDC_ssp370_2100.tif", 
                              overwrite = TRUE)
  MDCnormal <- makeMDC_ROF(inputPath = "data/Normal_1961_1990_", 
                           years = 1990)
  MDCnormal <- postProcess(MDCnormal[[1]], rasterToMatch = RTMraster,
                           filename2 = "outputs/normalMDC_1961_1990.tif")
  
  changeInMDC_245 <- (MDCfuture245-MDCnormal)/MDCnormal 
  changeInMDC_245 <- changeInMDC_245*100
  writeRaster(changeInMDC_245, filename = "outputs/pctChangeInMDC_ssp245_2100.tif")
  changeInMDC_370 <- (MDCfuture370-MDCnormal)/MDCnormal 
  changeInMDC_370 <- changeInMDC_370*100
  writeRaster(changeInMDC_370, filename = "outputs/pctChangeInMDC_ssp370_2100.tif")
}

